# Моніторинг та сповіщення платформи "БукМаркет"

## Таблиця операційних метрик для моніторингу

| № | Метрика | Вимірювання | Частота збору | Зв'язок з інфраструктурними ресурсами | Джерело даних | Метод збору |
|---|---------|-------------|---------------|--------------------------------------|---------------|------------|
| 1 | Час відгуку API | мс | Безперервно | AWS API Gateway, ECS сервіси | Логи API Gateway | CloudWatch Metrics |
| 2 | Доступність сервісів | % | Безперервно | Всі сервіси (ECS, RDS, ElastiCache) | Health checks | CloudWatch, Prometheus |
| 3 | Утилізація CPU | % | Кожні 5 хв | EC2, ECS, RDS | CloudWatch | CloudWatch Agent |
| 4 | Утилізація пам'яті | % | Кожні 5 хв | EC2, ECS, ElastiCache | CloudWatch | CloudWatch Agent |
| 5 | Кількість помилок авторизації | Кількість | Кожні 15 хв | Сервіс авторизації, Cognito | Логи додатку | ELK Stack |
| 6 | Кількість невдалих транзакцій | Кількість | Кожні 15 хв | Платіжний сервіс, RDS | Логи транзакцій | ELK Stack |
| 7 | Час обробки транзакцій | мс | Безперервно | Платіжний сервіс, RDS | Логи сервісу | Prometheus |
| 8 | Затримка бази даних | мс | Безперервно | RDS | CloudWatch RDS Metrics | CloudWatch |
| 9 | Кількість запитів до API за хвилину | Кількість | Кожну хвилину | API Gateway | Логи API Gateway | CloudWatch |
| 10 | Використання дискового простору | % | Кожні 15 хв | RDS, S3, EC2 | CloudWatch | CloudWatch |
| 11 | Кількість активних сесій | Кількість | Кожні 5 хв | ElastiCache, RDS | Логи сервісу | Prometheus |
| 12 | Середній час завантаження сторінки | мс | Кожні 5 хв | CloudFront, S3 | RUM (Real User Monitoring) | CloudWatch RUM |
| 13 | Затримка між мікросервісами | мс | Безперервно | ECS, API Gateway | X-Ray, сервісні логи | AWS X-Ray |
| 14 | Кількість одночасних користувачів | Кількість | Кожні 5 хв | ECS, ElastiCache | Логи додатку | ELK Stack |
| 15 | Розмір черги повідомлень | Кількість | Кожну хвилину | SQS | CloudWatch SQS Metrics | CloudWatch |

## Методологія збору метрик

### Інфраструктурні метрики
- **CloudWatch**: Основне джерело для збору метрик з AWS-ресурсів (EC2, RDS, ElastiCache, SQS)
- **CloudWatch Agent**: Встановлюється на EC2 інстанси для збору детальних метрик про систему
- **AWS X-Ray**: Для трасування запитів між мікросервісами та виявлення вузьких місць

### Метрики додатку
- **Prometheus**: Збір метрик з мікросервісів через експортери
- **ELK Stack**: Централізований збір та аналіз логів
  - Logstash для обробки та фільтрації логів
  - Elasticsearch для зберігання та індексації
  - Kibana для візуалізації та аналізу

### Метрики користувацького досвіду
- **CloudWatch RUM**: Відстеження взаємодії користувачів з веб-інтерфейсом
- **Custom SDK**: Вбудовані в мобільний додаток метрики для відстеження продуктивності

### Агрегація та зберігання
- Метрики зберігаються в Amazon Timestream для ефективного зберігання часових рядів
- Історичні дані архівуються в S3 для довгострокового зберігання та аналізу

## Таблиця порогових значень для сповіщень

| № | Метрика | Мінімальне допустиме значення | Максимальне допустиме значення | Тип сповіщення | Критичність | Кому надсилається |
|---|---------|------------------------------|--------------------------------|----------------|-------------|------------------|
| 1 | Час відгуку API | - | 500 мс | Email, SMS | Висока | DevOps, Backend команда |
| 2 | Доступність сервісів | 99.9% | - | Email, SMS, Дзвінок | Критична | DevOps, CTO, Product команда |
| 3 | Утилізація CPU | - | 80% | Email | Середня | DevOps |
| 4 | Утилізація пам'яті | - | 85% | Email | Середня | DevOps |
| 5 | Кількість помилок авторизації | - | 10 за 5 хв | Email | Висока | Security team, Backend команда |
| 6 | Кількість невдалих транзакцій | - | 5 за 15 хв | Email, SMS | Критична | DevOps, Payment team, CTO |
| 7 | Час обробки транзакцій | - | 2000 мс | Email | Висока | Payment team |
| 8 | Затримка бази даних | - | 100 мс | Email | Висока | DevOps, DBA |
| 9 | Кількість запитів до API за хвилину | - | 5000 | Email | Середня | DevOps, Backend команда |
| 10 | Використання дискового простору | - | 85% | Email | Середня | DevOps |

## План пом'якшення для критичних ситуацій (Mitigation plan)

### 1. Низька доступність сервісів (< 99.9%)
**Критичність: Критична**

**План реагування:**
1. Автоматичне перенаправлення трафіку на резервні інстанси через AWS Route 53
2. Активація резервних зон доступності
3. Перевірка стану бази даних та кеш-систем
4. Аналіз логів для виявлення причини недоступності
5. Якщо проблема з RDS - активація автоматичного failover на резервну репліку
6. Комунікація з користувачами через соціальні мережі та email

**Превентивні заходи:**
- Регулярне тестування сценаріїв відмови (disaster recovery)
- Використання AWS Auto Scaling для забезпечення відмовостійкості
- Періодичний аудит інфраструктури на відповідність SLA

### 2. Велика кількість невдалих транзакцій (> 5 за 15 хв)
**Критичність: Критична**

**План реагування:**
1. Тимчасове призупинення прийому нових транзакцій
2. Перевірка з'єднання з платіжними системами
3. Перевірка логів транзакцій для виявлення патерну помилок
4. Перемикання на альтернативну платіжну систему якщо причина в ній
5. Зв'язок з банком-еквайєром у випадку проблем на їхньому боці
6. Повідомлення користувачів про тимчасові технічні труднощі

**Превентивні заходи:**
- Реалізація механізму компенсуючих транзакцій
- Інтеграція з кількома платіжними провайдерами для резервування
- Автоматичне тестування платіжного процесу кожні 5 хвилин

### 3. Високий час відгуку API (> 500 мс)
**Критичність: Висока**

**План реагування:**
1. Активація додаткових обчислювальних ресурсів через Auto Scaling
2. Аналіз запитів, що викликають затримки, через AWS X-Ray
3. Тимчасове зменшення кешування для критичних ендпоінтів
4. Перевірка індексів у базі даних
5. Ізоляція повільних мікросервісів для мінімізації впливу

**Превентивні заходи:**
- Оптимізація запитів до бази даних
- Реалізація ефективних стратегій кешування
- Навантажувальне тестування перед релізами

### 4. Висока кількість помилок авторизації (> 10 за 5 хв)
**Критичність: Висока**

**План реагування:**
1. Активація додаткових заходів безпеки (CAPTCHA, rate limiting)
2. Аналіз IP-адрес, з яких надходять запити
3. Тимчасове блокування підозрілих IP-адрес
4. Аналіз патернів атак у логах
5. Перевірка інтеграції з AWS Cognito

**Превентивні заходи:**
- Впровадження AWS WAF для захисту від відомих атак
- Регулярні перевірки безпеки авторизаційного сервісу
- Моніторинг підозрілої активності

### 5. Висока затримка бази даних (> 100 мс)
**Критичність: Висока**

**План реагування:**
1. Перевірка поточних виконуваних запитів та їх термінація при необхідності
2. Аналіз повільних запитів через RDS Performance Insights
3. Перенаправлення запитів на читання на репліки бази даних
4. Тимчасове збільшення ресурсів RDS інстансу
5. Оптимізація або обмеження складних запитів

**Превентивні заходи:**
- Регулярний аналіз та оптимізація індексів
- Використання кешування для зменшення навантаження на БД
- Моніторинг повільних запитів та їх оптимізація 